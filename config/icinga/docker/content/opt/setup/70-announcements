#!/bin/bash

. /opt/helpers

ALL_MESSAGES=""

function announce(){
	local  author="${ICINGAWEB2_ADMIN_USER}"
	local message="${1}"
	local    hash="$(md5sum <<< "${message}" | awk '{print $1}')"
	local   start=$(date '+%s' --date='today')
	local     end=$(date '+%s' --date='year')

	local message_website="$(sed 's/\\n/ /g'    <<< ${message})"
	local message_console="$(sed 's/\\n/\n  /g' <<< ${message})"

	ini_set /etc/icingaweb2/announcements.ini "$hash" "author"  "\"$author\""
	ini_set /etc/icingaweb2/announcements.ini "$hash" "message" "\"$message_website\""
	ini_set /etc/icingaweb2/announcements.ini "$hash" "start"   "\"$start\""
	ini_set /etc/icingaweb2/announcements.ini "$hash" "end"     "\"$end\""
	ini_set /etc/icingaweb2/announcements.ini "$hash" "hash"    "\"$hash\""

	ALL_MESSAGES+="- ${message_console}"$'\n'
}

# From jessie to stretch, the php sessions folder changed,
# forcing users to relogin upon container restart
if mountpoint -q /var/lib/php5/sessions; then
	announce "The PHP sessions folder switched to /var/lib/php/sessions (mind the missing 5 in php).\nIf you do not change, the sessions are lost after container restart."
fi

# old variables for passwords
[ -z "${IDO_PASSWORD+x}" ] \
	|| announce "The IDO_PASSWORD variable had been replaced with ICINGA2_IDO_MYSQL_PASS.\nPlease read through the README."
[ -z "${DIRECTOR_PASSWORD+x}" ] \
	|| announce "The DIRECTOR_PASSWORD variable had been replaced with ICINGAWEB2_DIRECTOR_MYSQL_PASS.\nPlease read through the README."
[ -z "${ICINGAWEB2_PASSWORD+x}" ] \
	|| announce "The ICINGAWEB2_PASSWORD variable had been replaced with ICINGAWEB2_MYSQL_PASS.\nPlease read through the README."

[ ! "$(ls -A /var/lib/mysql)" ] \
	|| announce "Your MySQL Database Server is running currently inside the icinga2 container.\nIn future, the MySQL will be located in a separate container by default.\nFind more information at https://github.com/jjethwa/icinga2#moving-to-separate-mysql-container"

if hostname | grep -qP '^[0-9a-f]{12}$'; then
	announce "The hostname of this container is randomly generated by docker.\nPlease set your hostname by either using '--hostname' or setting the 'hostname' field in your 'docker-compose.yml' to prevent CA trust issues in API connections."
fi

if [ "${ALL_MESSAGES}" != "" ]; then
	cat >&2 <<-END
	===================================================================

	                      OLD SETTINGS DETECTED

	Your icinga container has got some old settings, see here:
	${ALL_MESSAGES}
	END
fi
